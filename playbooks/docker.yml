---
- name: Install docker
  hosts: "{{ rke | default('rke') }}"
  tasks:
    - name: Include collection variables
      ansible.builtin.include_vars:
        file: main.yml

    - name: Set install facts
      ansible.builtin.set_fact:
        docker_user: "{{ rke_install_user }}"

    - name: Disable active swap volume
      ansible.builtin.shell: swapoff -a
      tags: skip_ansible_lint
      become: true

    - name: Disable swap fstab entry
      ansible.builtin.lineinfile:
        state: absent
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
      become: true

    - name: Install Docker repository
      ansible.builtin.include_role:
        name: nephelaiio.rke.docker
        tasks_from: repo
        apply:
          become: true

    - name: Query Docker releases
      ansible.builtin.shell:
        cmd: "apt-cache madison {{ item }} | awk -F'|' '{ print $2 }' | grep {{ rke_release_docker }} | xargs"
        executable: "/bin/bash"
      loop: "{{ rke_docker_packages }}"
      register: _docker_versions

    - name: Install Docker
      ansible.builtin.include_role:
        name: nephelaiio.rke.docker
        apply:
          become: true
      vars:
        docker_packages: "{{ _docker_versions.results | map('nephelaiio.plugins.map_join', ['item', 'stdout'], '=') }}"
